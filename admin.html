<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Manage Blog Posts</title>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <!-- Quill CSS & JS -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: #f7f8fa;
    }
    h1 {
      background: #24292e;
      color: white;
      margin: 0;
      padding: 20px;
      text-align: center;
      font-weight: 600;
      position: relative;
    }
    #logout-btn {
      position: absolute;
      top: 20px; right: 20px;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      display: none;
      z-index: 10;
    }
    #login-section, #admin-section {
      max-width: 720px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      font-size: 14px;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="date"],
    input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }
    button[type="submit"], #save-post {
      margin-top: 20px;
      background: #2ecc71;
      border: none;
      padding: 12px 18px;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      width: 100%;
    }
    button[type="submit"]:hover, #save-post:hover {
      background: #27ae60;
    }
    #editor-container {
      height: 220px;
      margin-top: 10px;
    }
    .post-item {
      background: #f0f0f0;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      position: relative;
      word-wrap: break-word;
    }
    .post-item h3 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    .post-item small {
      color: #555;
      font-style: italic;
      margin-bottom: 10px;
      display: block;
    }
    .delete-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #e74c3c;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    img.post-image {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
      display: block;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      height: auto;
    }
    #posts-list {
      margin-top: 30px;
    }
    #login-error {
      margin-top: 12px;
      color: #e74c3c;
      font-weight: 600;
    }
  </style>
</head>
<body>

<h1>Admin Panel - Manage Blog Posts
  <button id="logout-btn">Logout</button>
</h1>

<div id="login-section">
  <h2>Admin Login</h2>
  <form id="login-form">
    <label for="email">Email</label>
    <input id="email" type="email" required />
    <label for="password">Password</label>
    <input id="password" type="password" required />
    <button type="submit">Login</button>
  </form>
  <p id="login-error"></p>
</div>

<div id="admin-section" style="display:none;">
  <h2>Create New Post</h2>
  <form id="post-form">
    <label for="title">Title</label>
    <input id="title" type="text" placeholder="Enter post title" required />

    <label for="author">Author</label>
    <input id="author" type="text" placeholder="Author name" required />

    <label for="image">Featured Image (optional)</label>
    <input id="image" type="file" accept="image/*" />

    <label for="date">Date</label>
    <input id="date" type="date" required />
    
    <label for="editor-container">Content</label>
    <div id="editor-container"></div>
    <button id="save-post" type="submit">Save Post</button>
  </form>

  <h2>Existing Posts</h2>
  <div id="posts-list">Loading posts...</div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdeme0EVSoDmtKS2kjJb9lz_om82VxTSo",
    authDomain: "bloging-1e7df.firebaseapp.com",
    projectId: "bloging-1e7df",
    storageBucket: "bloging-1e7df.appspot.com",
    messagingSenderId: "177297831056",
    appId: "1:177297831056:web:4cc414cdeb9e4ebe14d415"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // Initialize Quill editor
  const quill = new Quill('#editor-container', {
    theme: 'snow',
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline', 'strike'],
        ['blockquote', 'code-block'],
        [{ 'header': 1 }, { 'header': 2 }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        [{ 'script': 'sub'}, { 'script': 'super' }],
        [{ 'indent': '-1'}, { 'indent': '+1' }],
        [{ 'direction': 'rtl' }],
        [{ 'size': ['small', false, 'large', 'huge'] }],
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'color': [] }, { 'background': [] }],
        [{ 'font': [] }],
        [{ 'align': [] }],
        ['clean'],
        ['link', 'image', 'video']
      ]
    }
  });

  // Elements
  const loginSection = document.getElementById('login-section');
  const adminSection = document.getElementById('admin-section');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const logoutBtn = document.getElementById('logout-btn');
  const postForm = document.getElementById('post-form');
  const postsList = document.getElementById('posts-list');
  const imageInput = document.getElementById('image');
  const savePostBtn = document.getElementById('save-post');

  // Auth state change
  auth.onAuthStateChanged(user => {
    if (user && user.email === 'roqfatma786@gmail.com') {
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      logoutBtn.style.display = 'inline-block';
      fetchPosts();
    } else {
      loginSection.style.display = 'block';
      adminSection.style.display = 'none';
      logoutBtn.style.display = 'none';
      postsList.innerHTML = 'Please login to manage posts.';
    }
  });

  // Disable Firebase auth login form submission
  loginForm.removeEventListener('submit', () => {});

  // Hardcoded admin credentials (change as needed)
  const ADMIN_EMAIL = "admin@example.com";
  const ADMIN_PASSWORD = "admin123";

  // Remove Firebase auth listeners by overriding the login form submit
  loginForm.addEventListener('submit', e => {
    e.preventDefault();

    const email = loginForm.email.value.trim();
    const password = loginForm.password.value.trim();

    loginError.textContent = '';

    // Simple validation
    if (email === '' || password === '') {
      loginError.textContent = 'Please enter email and password.';
      return;
    }

    // Check against hardcoded credentials
    if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
      // Successful login

      // Hide login section and show admin section
      loginSection.style.display = 'none';
      adminSection.style.display = 'block';
      logoutBtn.style.display = 'inline-block';

      // Reset form and error
      loginForm.reset();
      loginError.textContent = '';

      // Optionally, fetch posts now that admin is logged in
      fetchPosts();
    } else {
      loginError.textContent = 'Invalid email or password.';
    }
  });

  // Logout button to clear session and revert UI
  logoutBtn.addEventListener('click', () => {
    // Show login, hide admin
    loginSection.style.display = 'block';
    adminSection.style.display = 'none';
    logoutBtn.style.display = 'none';

    // Clear any error messages and reset form
    loginError.textContent = '';
    loginForm.reset();
  });

  // Initially, make sure admin section is hidden and login visible
  loginSection.style.display = 'block';
  adminSection.style.display = 'none';
  logoutBtn.style.display = 'none';

  // Remove Firebase auth state listener to prevent interference
  if (typeof auth !== 'undefined' && auth.onAuthStateChanged) {
    auth.onAuthStateChanged(() => {});
  }


  // Save post
  postForm.addEventListener('submit', async e => {
    e.preventDefault();

    const title = postForm.title.value.trim();
    const author = postForm.author.value.trim();
    const date = postForm.date.value;
    const content = quill.root.innerHTML.trim();

    if (!title || !author || !date || !content || content === '<p><br></p>') {
      alert('Please fill all required fields and add some content.');
      return;
    }

    savePostBtn.disabled = true;
    savePostBtn.textContent = 'Saving...';

    let imageUrl = null;

    if (imageInput.files.length > 0) {
      try {
        const file = imageInput.files[0];
        const storageRef = storage.ref();
        const imageRef = storageRef.child(`post-images/${Date.now()}_${file.name}`);
        await imageRef.put(file);
        imageUrl = await imageRef.getDownloadURL();
      } catch (uploadErr) {
        alert('Error uploading image: ' + uploadErr.message);
        savePostBtn.disabled = false;
        savePostBtn.textContent = 'Save Post';
        return;
      }
    }

    try {
      await db.collection('posts').add({
        title,
        author,
        date,
        content,
        imageUrl: imageUrl || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Post saved successfully!');
      postForm.reset();
      quill.setContents([]);
      fetchPosts();
    } catch (err) {
      alert('Error saving post: ' + err.message);
    } finally {
      savePostBtn.disabled = false;
      savePostBtn.textContent = 'Save Post';
    }
  });

  // Fetch and display posts
  async function fetchPosts() {
    postsList.innerHTML = 'Loading posts...';
    try {
      const snapshot = await db.collection('posts').orderBy('createdAt', 'desc').get();
      if (snapshot.empty) {
        postsList.innerHTML = '<p>No posts found.</p>';
        return;
      }
      postsList.innerHTML = '';
      snapshot.forEach(doc => {
        const post = doc.data();
        const postId = doc.id;

        const postDiv = document.createElement('div');
        postDiv.classList.add('post-item');

        let formattedDate = post.date;
        if (post.date) {
          try {
            formattedDate = new Date(post.date).toLocaleDateString();
          } catch {}
        }

        postDiv.innerHTML = `
          <h3>${escapeHtml(post.title)}</h3>
          <small>By ${escapeHtml(post.author)} on ${formattedDate}</small>
          <div>${post.content}</div>
          ${post.imageUrl ? `<img class="post-image" src="${post.imageUrl}" alt="Post Image">` : ''}
          <button class="delete-btn" data-id="${postId}">Delete</button>
        `;
        postsList.appendChild(postDiv);
      });

      // Attach delete handlers
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (confirm('Are you sure you want to delete this post?')) {
            try {
              await db.collection('posts').doc(btn.dataset.id).delete();
              alert('Post deleted.');
              fetchPosts();
            } catch (err) {
              alert('Error deleting post: ' + err.message);
            }
          }
        });
      });
    } catch (err) {
      postsList.innerHTML = 'Error loading posts: ' + err.message;
    }
  }

  // Simple HTML escape function for safety in displayed text
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
<script>
let loginCooldown = false;

loginForm.addEventListener('submit', e => {
  e.preventDefault();

  if (loginCooldown) {
    loginError.textContent = "Please wait a few seconds before trying again.";
    return;
  }

  const email = loginForm.email.value;
  const password = loginForm.password.value;
  loginError.textContent = '';
  loginForm.querySelector('button[type="submit"]').disabled = true;

  auth.signInWithEmailAndPassword(email, password)
    .then(() => {
      loginForm.reset();
    })
    .catch(err => {
      if (err.code === 'auth/too-many-requests') {
        loginError.textContent = "Too many login attempts. Please try again later.";
      } else {
        loginError.textContent = err.message;
      }
    })
    .finally(() => {
      loginForm.querySelector('button[type="submit"]').disabled = false;
      loginCooldown = true;
      setTimeout(() => {
        loginCooldown = false;
      }, 5000); // 5 seconds cooldown before next attempt
    });
});
</script>
</body>
</html>
